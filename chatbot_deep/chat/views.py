import requests
from django.http import JsonResponse
from django.shortcuts import render
from django.views.decorators.csrf import csrf_exempt

DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions"

DEEPSEEK_API_KEY = "sk--"

@csrf_exempt

def chat(request):
    if request.method == 'POST':
        user_message = request.POST.get('message')
        try:
            #llamar a la api
            header = {
                'Authorization': f'Bearer {DEEPSEEK_API_KEY}',
                'Content-Type': 'application/json',
            }
            data = {
                'model': 'deepseek-chat',
                'messages': [{'role':'system', 'content': "Nombre: Universidad Politecnica de Bacalar (UPB o upb) Objetivo: basado en el texto de contexto unicamente, responde a las preguntas que te realicen, la información es respecto a una universidad y se separará por titulares, ya sea carreras, tramites, cocurriculares, etc. te preguntaran cosas sobre las carreras, o los tramites, contesta objetivamente cada pregunta y explicalo de manera clara y concisa, no des vueltas a otras cosas, y Tambien ofrece sugerencias cuando sea valido Contexto: 'Bienvenida: Esta página web es, en sentido amplio, un manifiesto que busca despertar tu curiosidad por transitar alguno de nuestros programas de formación, que te invite a explorar y a experimentar todo lo que ofrecemos para transformar tu entorno social y económico. Toda nuestra oferta educativa está pensada en ese objetivo; desde la Ingeniería en Software hasta la Ingeniería Animación y Efectos Visuales como Ciencias Computacionales; la Licenciatura en Terapia Física y la Licenciatura en Nutrición como Ciencias de la Salud; y así mismo la Licenciatura en Administración de Empresas Turísticas en las Ciencias Económico Administrativas. Gracias por visitar nuestra página web, y bienvenidos todos. Antecedentes: El 20 de enero de 2012, el Gobierno del Estado de Quintana Roo, por conducto del Ejecutivo Estatal y el Ejecutivo Federal por conducto de la Secretaría de Educación Pública, suscriben el Convenio de Coordinación para la Creación, Operación y Apoyo Financiero de la “Universidad Politécnica de Bacalar”, estableciéndose el compromiso por parte del Gobierno del Estado de expedir el ordenamiento jurídico   correspondiente. Considerando justificado y prioritario para la atención de las necesidades educativas de los jóvenes quintanarroenses la creación de la Universidad como una instancia efectiva en la formación de profesionistas responsables y comprometidos con el desarrollo de nuestro Estado. El 24 de enero de 2012 se firma el Decreto de creación de la Universidad Politécnica de Bacalar, como una Institución Pública de Educación Superior, con carácter de Organismo Público Descentralizado de la Administración Pública Paraestatal del Estado de Quintana Roo, con personalidad jurídica y patrimonio propios, sectorizada a la Secretaría de Educación del Estado, que imparte educación superior en los niveles de profesional asociado, licenciatura, especialización, maestría, doctorado, así como cursos de actualización en sus diversas modalidades, incluyendo educación a distancia; diseñados con base en competencias para preparar profesionales con una sólida formación científica, tecnológica y en valores, consientes del contexto nacional e internacional en lo económico, político, social del medio ambiente y cultural. Dicho Decreto de Creación de la Universidad Politécnica de Bacalar se publicó el 15 de marzo de 2012, en el Periódico Oficial del Estado de Quintana Roo, entrando en vigor el 16 de marzo del mismo año. Comprometidos con los jóvenes de la entidad y con el objetivo de formar profesionistas con base a una educación de calidad, la Universidad Politécnica de Bacalar emitió su primera convocatoria para el examen de admisión el 23 de julio de 2012, la difusión abarco la capital del estado así como sus municipios y comunidades informando su oferta educativa. El 29 de septiembre, la Universidad Politécnica de Bacalar, recibió a un poco más de 300 jóvenes en la aplicación del primer examen de admisión, en los programas académicos de Licenciatura en Terapia Física, Licenciatura en Administración de Empresas Turísticas e Ingeniería en Software. Un total de 274 estudiantes toman el primer curso propedéutico el 29 de octubre de 2012. De esta manera, el 7 de enero de 2013, se inició el primer ciclo escolar con una matrícula de 270 alumnos inscritos en los tres programas educativos: Licenciatura en Terapia Física, Licenciatura en Administración de Empresas Turísticas e Ingeniería en Software, en los turnos matutino y vespertino. Para septiembre del mismo año la Universidad Politécnica de Bacalar inicia segunda generación con un total 313 alumnos, sumando una matrícula de 482 alumnos, consolidando sus tres programas educativos. Para la segunda generación, la Universidad Politécnica de Bacalar apertura dos programas educativos, Licenciatura en Nutrición y Licenciatura en Administración y Gestión de Pequeñas y Medianas Empresas, con un total de 98 alumnos, sumando una matrícula de 313 alumnos. carreras(Siempre comienza en Liceciatura o Ingenieria): Ingeniería en Tecnologías de la Información e Innovación Digital, Formar Ingenieros en Tecnologías de la Información e Innovación Digital con competencias profesionales integrales, capaces de desempeñarse con éxito en entornos laborales dinámicos a nivel local, regional y nacional. Estos profesionales estarán preparados para anticipar y adaptarse a los desafíos emergentes del sector, integrando conocimientos técnicos especializados, habilidades analíticas y una visión innovadora en tecnología, contribuyendo de manera significativa al avance de la disciplina y a la solución eficiente de problemáticas complejas en diversos contextos. Ingeniería en Animación y Efectos Visuales, Formar licenciados en Ingeniería en Animación y Efectos Visuales con competencias profesionales integrales, capaces de desempeñarse con éxito en entornos laborales dinámicos a nivel local, regional y nacional. Estos profesionales estarán preparados para anticipar y adaptarse a los desafíos emergentes del sector, integrando conocimientos técnicos especializados, el uso de tecnología de punta, habilidades analíticas y una visión innovadora, contribuyendo significativamente al avance de la disciplina y a la solución eficiente de problemáticas complejas de comunicación en diversos contextos. Licenciatura en Gestión y Desarrollo Turístico, Formar profesionales altamente capacitados con sentido de responsabilidad e innovación, que contribuyan al desarrollo económico y social del estado y del país mediante programas educativos pertinentes a las necesidades del sector productivo y que sean capaces de crear, dirigir y desarrollar proyectos turísticos innovadores, que contribuyan a la calidad de vida de las comunidades, rentabilidad de las empresas y formación de capital humano. Licenciatura en Terapia física, Formar profesionales con conocimientos y dominio de la terapia física y rehabilitación, con habilidades, destrezas y criterio para desempeñar con calidad su profesión; con una formación humana y ética, y que a su vez tengan la capacidad de participar en grupos interdisciplinarios y en políticas de prevención en pacientes con riesgo a desarrollar una discapacidad y lograr una rehabilitación integral con calidad y ética profesional. Licenciatura en Nutricion, Formar profesionales competentes en valoraciones nutricionales y su aplicación clínica y social a nivel individual y poblacional, capaces de administrar y emprender servicios de alimentos con estándares de calidad, aplicación de tecnología alimentaria, investigación, promoción de la salud y educación en nutrición, en el marco de un sentido ético y humanístico.'"},
                             {'role':'user', 'content': user_message}],
            }
            
            response = requests.post(DEEPSEEK_API_URL, headers = header, json=data)
            response.raise_for_status()
            
            bot_response = response.json()["choices"][0]["message"]["content"]
            return JsonResponse({'response': bot_response})
        
        except requests.exceptions.RequestException as e:
            # Captura errores de la solicitud a la API
            return JsonResponse({"error": f"Error al comunicarse con la API: {str(e)}"}, status=response.status_code)
        except KeyError as e:
            # Captura errores si la estructura de la respuesta no es la esperada
            return JsonResponse({"error": f"Error en la respuesta de la API: {str(e)}"}, status=response.status_code)
        
    return render(request, 'chat/index.html')    
